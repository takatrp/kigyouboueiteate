<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>企業防衛推進手当 集計ツール（代理店報酬明細書(詳細)）</title>

  <style>
    :root{
      --brand:#578899;
      --brand-dark:#456d77;
      --bg:#f4f6fa;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent-soft:#e5f0f6;
      --subtotal-bg:#fef9c3;
      --chip-bg:#eef2f7;
      --chip-bg-active:#e0edf4;
      --danger:#b91c1c;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      padding:24px 16px 40px;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--ink);
    }
    .shell{max-width:1040px;margin:0 auto;}
    .card{
      background:var(--card);
      border-radius:16px;
      padding:20px 20px 24px;
      box-shadow:0 14px 35px rgba(15,23,42,0.08);
    }

    h1{
      font-size:1.4rem;
      margin:0 0 6px;
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    h1 .badge{
      font-size:0.72rem;
      padding:2px 8px;
      border-radius:999px;
      background:#e0edf4;
      color:var(--brand-dark);
      font-weight:600;
    }
    .subtitle{
      font-size:0.88rem;
      color:var(--muted);
      margin-bottom:10px;
    }

    .flow{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:14px;
      font-size:0.8rem;
    }
    .flow-step{
      display:flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      background:var(--accent-soft);
      color:#1f2933;
      white-space:nowrap;
    }
    .flow-step .step-no{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:20px;height:20px;
      border-radius:999px;
      background:var(--brand);
      color:#fff;
      font-size:0.72rem;
      font-weight:700;
    }
    .flow-step .step-text{font-weight:500;}

    form{margin:0;}
    .workflow-grid{
      display:grid;
      grid-template-columns: 1.6fr 0.9fr;
      gap:14px;
      align-items:start;
      margin-bottom:10px;
    }
    .step-card{
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      padding:12px;
      box-shadow:0 6px 14px rgba(15,23,42,0.05);
    }
    .step-card-head{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
      padding-bottom:8px;
      border-bottom:1px dashed #e5e7eb;
    }
    .step-pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      padding:3px 10px;
      background:var(--brand);
      color:#fff;
      font-size:0.75rem;
      font-weight:800;
      letter-spacing:0.02em;
    }
    .step-title{
      font-weight:800;
      color:#111827;
      font-size:0.92rem;
    }
    .step-desc{
      margin-left:auto;
      color:var(--muted);
      font-size:0.78rem;
      font-weight:500;
      white-space:nowrap;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:0.86rem;
    }
    label{color:var(--muted);}
    input[type="number"],
    input[type="file"],
    input[type="text"]{
      font-size:0.9rem;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid var(--border);
      background:#f9fafb;
    }
    input[type="number"]:focus,
    input[type="file"]:focus,
    input[type="text"]:focus{
      outline:none;
      border-color:var(--brand);
      box-shadow:0 0 0 1px rgba(87,136,153,0.25);
      background:#fff;
    }

    /* 対象年/月は自動表示（入力不可） */
    input.readonly{
      background:#f3f4f6;
      color:#111827;
    }
    input.readonly[readonly]{cursor:default;}

    .step1-body{display:grid;gap:12px;}
    .two-col{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }

    /* 料率：入力欄の右にチップ（1行固定・スクロールなし・一覧表示） */
    .rate-inline{
      display:grid;
      grid-template-columns: 96px 1fr; /* 入力欄を少し細くしてチップ側を広く */
      gap:8px;
      align-items:center;
    }
    .chips{
      display:flex;
      gap:4px;              /* 余白を詰める */
      flex-wrap:nowrap;     /* 1行固定 */
      overflow:visible;     /* スクロールしない */
    }
    .chip{
      flex:1 1 0;           /* ★均等割り＆縮める */
      min-width:0;          /* ★縮小を許可（重要） */
      border:1px solid var(--border);
      background:var(--chip-bg);
      color:#111827;
      border-radius:999px;
      padding:5px 6px;      /* ★左右を狭く */
      font-size:0.78rem;    /* ★少し小さく */
      line-height:1;
      cursor:pointer;
      user-select:none;
      box-shadow:0 2px 6px rgba(148,163,184,0.14);
      text-align:center;
      white-space:nowrap;
    }
    .chip:hover{background:#e5e7eb;}
    .chip.active{
      border-color:rgba(87,136,153,0.7);
      background:var(--chip-bg-active);
      box-shadow:0 6px 14px rgba(87,136,153,0.18);
      font-weight:800;
      color:var(--brand-dark);
    }

    /* 右側：STEP2→3→4 を縦並び */
    .button-row{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:stretch;
    }
    button{
      padding:10px 16px;
      border-radius:999px;
      border:none;
      font-size:0.92rem;
      font-weight:700;
      cursor:pointer;
      transition:background 0.15s ease, transform 0.05s ease, box-shadow 0.15s ease;
      width:100%;
      text-align:center;
    }
    button.primary{
      background:var(--brand);
      color:#fff;
      box-shadow:0 8px 20px rgba(87,136,153,0.35);
    }
    button.primary:hover{background:var(--brand-dark);box-shadow:0 10px 24px rgba(87,136,153,0.42);}
    button.primary:active{transform:translateY(1px);box-shadow:0 6px 16px rgba(87,136,153,0.35);}
    button.secondary{
      background:#e5e7eb;
      color:#111827;
      box-shadow:0 3px 8px rgba(148,163,184,0.35);
    }
    button.secondary:hover{background:#d1d5db;}
    button.secondary:active{transform:translateY(1px);box-shadow:0 2px 6px rgba(148,163,184,0.30);}
    button:disabled{background:#cbd5e1;box-shadow:none;cursor:default;}

    .check-label{
      display:flex;
      align-items:flex-start;
      gap:8px;
      cursor:pointer;
      font-size:0.9rem;
      color:#111827;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#f9fafb;
    }
    .check-label small{
      display:block;
      color:var(--muted);
      font-size:0.78rem;
      font-weight:500;
      margin-top:2px;
      line-height:1.35;
    }
    .check-label input[type="checkbox"]{
      margin-top:2px;
      width:18px;height:18px;cursor:pointer;
      accent-color: var(--brand);
      flex:0 0 auto;
    }

    /* 集計後のレポート見出し（画面/印刷共通） */
    .report-head{
      display:none;
      border:1px solid var(--border);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      margin:10px 0 8px;
    }
    .report-title{
      font-weight:900;
      font-size:1.02rem;
      margin:0 0 4px;
      color:#0f172a;
    }
    .report-meta{
      display:flex;
      flex-wrap:wrap;
      gap:10px 14px;
      font-size:0.84rem;
      color:#334155;
    }
    .meta-item{
      display:flex;
      gap:6px;
      align-items:baseline;
      white-space:nowrap;
    }
    .meta-key{color:var(--muted);}
    .meta-val{font-weight:700;}

    .file-info{
      font-size:0.8rem;
      color:var(--muted);
      margin:6px 0 8px;
    }
    .status{
      font-size:0.82rem;
      color:var(--muted);
      min-height:1.2em;
      margin-bottom:6px;
    }
    .status.err{color:var(--danger);font-weight:700;}
    .summary{
      font-size:0.92rem;
      font-weight:700;
      margin:6px 0 10px;
    }
    .summary .highlight{color:var(--brand-dark);}

    /* 結果テーブル */
    .table-wrapper{
      max-height:520px;
      overflow:auto;
      border-radius:10px;
      border:1px solid var(--border);
      background:#f9fafb;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:0.84rem;
      background:#fff;
    }
    thead tr{
      background:#f3f4f6;
      position:sticky;
      top:0;
      z-index:1;
    }
    th, td{
      padding:6px 8px;
      border-bottom:1px solid #edf0f3;
      text-align:left;
      vertical-align:middle;
    }
    th{
      font-weight:800;
      color:#374151;
      white-space:nowrap;
    }
    td.num{
      text-align:right;
      font-variant-numeric:tabular-nums;
      white-space:nowrap;
    }
    tr:nth-child(even) td.detail-row-cell{background:#f9fafb;}
    .group-header td{
      background:var(--accent-soft);
      font-weight:800;
      color:#1f2937;
      border-bottom:1px solid #d1d5db;
    }
    .group-header .label{opacity:0.9;}
    .subtotal-row td{
      background:var(--subtotal-bg);
      font-weight:900;
      border-top:1px solid #eab308;
      border-bottom:1px solid #eab308;
    }
    .subtotal-input{
      max-width:160px;
      font-size:0.84rem;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid var(--border);
      background:#fff;
    }

    /* 該当無しメッセージ（印刷も可能） */
    .no-match{
      display:none;
      margin-top:10px;
      padding:12px;
      border-radius:12px;
      border:1px dashed #cbd5e1;
      background:#ffffff;
      color:#334155;
      font-weight:800;
    }

    .note{
      font-size:0.8rem;
      color:var(--muted);
      margin-top:10px;
      line-height:1.55;
    }

    @media (max-width: 860px){
      .workflow-grid{grid-template-columns: 1fr;}
      .two-col{grid-template-columns:1fr;}
      .step-desc{display:none;}
      /* スマホでは入力の下にチップ（1行固定・スクロールなし） */
      .rate-inline{grid-template-columns: 1fr;}
    }
    @media (max-width: 420px){
      .rate-inline{grid-template-columns: 88px 1fr;}
      .chip{padding:4px 4px;font-size:0.74rem;}
    }

    /* 印刷調整：改ページ後の被りを防ぐ（sticky解除＋ヘッダー繰り返し＋wrapper解除） */
    @media print{
      body{background:#fff;padding:0;}
      .card{box-shadow:none;border-radius:0;padding:14px 16px;}
      .flow{display:none !important;}
      form{display:none !important;}
      .status, .file-info{display:none !important;}

      .report-head{display:block !important; page-break-inside:avoid;}
      .summary{margin-top:8px;}

      .table-wrapper{
        max-height:none !important;
        overflow:visible !important;
        border:none !important;
        background:transparent !important;
        display:block !important;
      }
      table{font-size:0.86rem;}
      thead{display:table-header-group;}
      thead tr{position:static !important;}
      tfoot{display:table-footer-group;}
      tr, td, th{page-break-inside:avoid; break-inside:avoid;}
      .no-match{display:block !important; page-break-inside:avoid;}
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
<div class="shell">
  <div class="card">
    <h1>
      企業防衛推進手当 集計ツール
      <span class="badge">代理店報酬明細書(詳細) シート対応</span>
    </h1>
    <div class="subtitle">
      「代理店報酬明細書(詳細)」シートから、<strong>初年度第1回報酬 × 12ヶ月 × 料率</strong> を契約者ごとに集計し、担当者入力と目視確認付きのレポートを作成します。
    </div>

    <div class="flow">
      <div class="flow-step"><span class="step-no">1</span><span class="step-text">対象年月とファイルを指定</span></div>
      <div class="flow-step"><span class="step-no">2</span><span class="step-text">「集計する」を押す</span></div>
      <div class="flow-step"><span class="step-no">3</span><span class="step-text">内容を確認し「目視確認済み」にチェック</span></div>
      <div class="flow-step"><span class="step-no">4</span><span class="step-text">「PDF/印刷」でレポート出力</span></div>
    </div>

    <form id="controlForm" onsubmit="return false;">
      <div class="workflow-grid">
        <!-- 左：STEP1（入力） -->
        <section class="step-card">
          <div class="step-card-head">
            <span class="step-pill">STEP1</span>
            <div class="step-title">入力（Excel・対象年月・料率）</div>
            <div class="step-desc">左→右で作業</div>
          </div>

          <div class="step1-body">
            <div class="field">
              <label for="xlsxFile">代理店報酬明細書（.xlsx）</label>
              <input type="file" id="xlsxFile" accept=".xlsx,.xls" />
            </div>

            <div class="two-col">
              <div class="field">
                <label>対象年（自動）</label>
                <input type="text" id="year" class="readonly" value="" readonly placeholder="ファイル名から自動取得" />
              </div>
              <div class="field">
                <label>対象月（自動）</label>
                <input type="text" id="month" class="readonly" value="" readonly placeholder="ファイル名から自動取得" />
              </div>
            </div>

            <div class="field">
              <label for="ratePct">料率（%）</label>
              <div class="rate-inline">
                <input type="number" id="ratePct" value="10" min="0" max="100" step="0.1" />
                <div class="chips" id="rateChips" aria-label="料率チップ（1行固定・一覧表示）">
                  <button type="button" class="chip active" data-rate="10">10%</button>
                  <button type="button" class="chip" data-rate="15">15%</button>
                  <button type="button" class="chip" data-rate="20">20%</button>
                  <button type="button" class="chip" data-rate="25">25%</button>
                  <button type="button" class="chip" data-rate="30">30%</button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- 右：STEP2-4（操作） -->
        <section class="step-card">
          <div class="step-card-head">
            <span class="step-pill">STEP2-4</span>
            <div class="step-title">集計・確認・印刷</div>
            <div class="step-desc">上→下で実行</div>
          </div>

          <div class="button-row">
            <button id="runBtn" type="button" class="primary">STEP2 集計する</button>

            <label class="check-label">
              <input type="checkbox" id="manualCheck" />
              <div>
                <div><strong>STEP3 目視確認済み</strong></div>
                <small>集計結果を確認した後にチェックしてください（チェックが無い場合、PDF/印刷はできません）</small>
              </div>
            </label>

            <button id="printBtn" type="button" class="secondary">STEP4 PDF/印刷</button>
          </div>
        </section>
      </div>
    </form>

    <div id="fileInfo" class="file-info"></div>
    <div id="status" class="status"></div>

    <!-- 印刷時に「読込ファイル名」を明示するためのレポートヘッダ -->
    <div class="report-head" id="reportHead">
      <div class="report-title" id="reportTitle"></div>
      <div class="report-meta">
        <div class="meta-item"><span class="meta-key">読込ファイル:</span><span class="meta-val" id="metaFile"></span></div>
        <div class="meta-item"><span class="meta-key">料率:</span><span class="meta-val" id="metaRate"></span></div>
        <div class="meta-item"><span class="meta-key">シート:</span><span class="meta-val">代理店報酬明細書(詳細)</span></div>
      </div>
    </div>

    <div id="summary" class="summary"></div>

    <div class="no-match" id="noMatchBox">該当無し（対象条件に一致する行はありません）</div>

    <div class="table-wrapper" id="tableWrapper" style="display:none;">
      <table id="resultTable">
        <thead>
          <tr>
            <th>契約者名</th>
            <th>担当者</th>
            <th>成績</th>
            <th>入金回数</th>
            <th>初年度第1回報酬（円）</th>
            <th>企業防衛推進手当（円）</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="note">
      ・対象年月は、ファイル名 <strong>9998974_YYYYMM.xlsx</strong> の YYYY/MM から自動取得します（入力不可）。<br />
      ・成績列に「初年度」を含み、かつ入金回数が「1」または「1-1」の行のみを対象とします。<br />
      ・企業防衛推進手当 ＝ 初年度第1回報酬 × 12ヶ月 × 料率（%/100）（円未満切捨て）で計算します。<br />
      ・契約者ごとに小計行を表示し、小計行に担当者名を入力できます（印刷・PDF にも反映）。<br />
      ・該当無しの場合でも、「目視確認済み」にチェックした上で PDF/印刷が可能です。
    </div>
  </div>
</div>

<script>
  function normalizeHeader(s){
    return String(s ?? "")
      .replace(/\s+/g, "")
      .replace(/[‐-‒–—―－]/g, "-")
      .replace(/[（）()]/g, "")
      .trim();
  }

  function parseAmount(val) {
    if (val == null) return 0;
    if (typeof val === "number") return Math.floor(val);
    const digits = String(val).replace(/[^\d]/g, "");
    return digits ? parseInt(digits, 10) : 0;
  }

  function findColumnKey(sampleRow, includeKeywords, excludeKeywords) {
    const keys = Object.keys(sampleRow || {});
    const includes = Array.isArray(includeKeywords) ? includeKeywords : [includeKeywords];
    const excludes = Array.isArray(excludeKeywords) ? excludeKeywords : (excludeKeywords ? [excludeKeywords] : []);

    const incN = includes.map(normalizeHeader);
    const excN = excludes.map(normalizeHeader);

    for (const key of keys) {
      const kN = normalizeHeader(key);
      const okInc = incN.every(t => kN.includes(t));
      const okExc = excN.every(t => !kN.includes(t));
      if (okInc && okExc) return key;
    }
    return null;
  }

  function normalizeNyukin(val) {
    if (val == null) return "";
    let s = String(val);
    s = s.replace(/[‐-‒–—―－]/g, "-");
    s = s.replace(/\s+/g, "");
    return s;
  }

  function parseYearMonthFromFilename(fileName) {
    if (!fileName) return null;
    // 9998974_202512.xlsx / _YYYYMM / 末尾YYYYMM などを許容
    let match = fileName.match(/_(\d{6})(?=\.(xlsx|xls)$)/i);
    if (!match) match = fileName.match(/(\d{6})(?=\.(xlsx|xls)$)/i);
    if (!match) return null;

    const yyyymm = match[1];
    const yearNum  = parseInt(yyyymm.slice(0, 4), 10);
    const monthNum = parseInt(yyyymm.slice(4, 6), 10);

    if (!Number.isFinite(yearNum) || yearNum < 2000 || yearNum > 2100) return null;
    if (!Number.isFinite(monthNum) || monthNum < 1 || monthNum > 12) return null;

    return { year: yearNum, month: monthNum };
  }

  (function init() {
    const statusEl       = document.getElementById("status");
    const summaryEl      = document.getElementById("summary");
    const tableWrapperEl = document.getElementById("tableWrapper");
    const tbodyEl        = document.querySelector("#resultTable tbody");
    const runBtn         = document.getElementById("runBtn");
    const printBtn       = document.getElementById("printBtn");
    const manualCheck    = document.getElementById("manualCheck");
    const fileInput      = document.getElementById("xlsxFile");
    const fileInfoEl     = document.getElementById("fileInfo");
    const yearInput      = document.getElementById("year");
    const monthInput     = document.getElementById("month");
    const rateInput      = document.getElementById("ratePct");
    const chipsWrap      = document.getElementById("rateChips");

    const reportHead     = document.getElementById("reportHead");
    const reportTitle    = document.getElementById("reportTitle");
    const metaFile       = document.getElementById("metaFile");
    const metaRate       = document.getElementById("metaRate");
    const noMatchBox     = document.getElementById("noMatchBox");

    let hasAggregated = false;
    let aggregateGen  = 0;
    let confirmedGen  = 0;

    function setStatus(msg, isErr=false) {
      statusEl.textContent = msg || "";
      statusEl.classList.toggle("err", !!isErr);
    }

    function syncActiveChip() {
      const current = parseFloat(rateInput.value);
      const chips = chipsWrap.querySelectorAll(".chip");
      chips.forEach(btn => {
        const r = parseFloat(btn.dataset.rate);
        btn.classList.toggle("active", Number.isFinite(current) && Number.isFinite(r) && current === r);
      });
    }

    chipsWrap.addEventListener("click", (ev) => {
      const btn = ev.target.closest(".chip");
      if (!btn) return;
      rateInput.value = btn.dataset.rate;
      syncActiveChip();
    });
    rateInput.addEventListener("input", syncActiveChip);

    function updateYearMonthUI(fileName) {
      const ym = parseYearMonthFromFilename(fileName);
      if (!ym) {
        yearInput.value = "";
        monthInput.value = "";
        return null;
      }
      yearInput.value = String(ym.year);
      monthInput.value = String(ym.month);
      return ym;
    }

    function updateFileInfo() {
      const file = fileInput.files[0];
      if (file) {
        fileInfoEl.textContent = "読込ファイル：" + file.name;
        updateYearMonthUI(file.name);
      } else {
        fileInfoEl.textContent = "";
        yearInput.value = "";
        monthInput.value = "";
      }
    }
    fileInput.addEventListener("change", updateFileInfo);

    manualCheck.addEventListener("change", () => {
      if (manualCheck.checked && hasAggregated) confirmedGen = aggregateGen;
      else confirmedGen = 0;
    });

    function updateReportHead({year, month, ratePct, fileName}) {
      reportTitle.textContent = `${year}年${month}月分 企業防衛推進手当 明細`;
      metaFile.textContent = fileName || "-";
      metaRate.textContent = `${ratePct}%`;
      reportHead.style.display = "block";
    }

    printBtn.addEventListener("click", () => {
      if (!hasAggregated) { setStatus("先に STEP2「集計する」を実行してください。", true); return; }
      if (!manualCheck.checked) { setStatus("STEP3「目視確認済み」にチェックを入れてから、STEP4「PDF/印刷」を行ってください。", true); return; }
      if (confirmedGen !== aggregateGen) { setStatus("最新の集計結果について、改めて「目視確認済み」にチェックを入れてください。", true); return; }

      setStatus("");

      // PDF保存時のファイル名候補（Chrome等ではタイトルが初期値になりやすい）
      const originalTitle = document.title;
      const yearVal = yearInput.value.trim();
      const monthVal = monthInput.value.trim();
      const monthNum = parseInt(monthVal, 10);

      let newTitle = originalTitle;
      if (yearVal && Number.isFinite(monthNum) && monthNum >= 1 && monthNum <= 12) {
        newTitle = `${yearVal}年${monthNum}月企業防衛手当明細`;
      }
      document.title = newTitle;

      window.print();

      setTimeout(() => { document.title = originalTitle; }, 1000);
    });

    runBtn.addEventListener("click", () => {
      const file = fileInput.files[0];

      // 表示クリア
      summaryEl.textContent = "";
      tbodyEl.innerHTML = "";
      tableWrapperEl.style.display = "none";
      noMatchBox.style.display = "none";
      reportHead.style.display = "none";

      if (!file) { setStatus("xlsx ファイルを選択してください。", true); return; }

      // 対象年月はファイル名から必須取得（入力不可）
      const ym = updateYearMonthUI(file.name);
      if (!ym) {
        setStatus("対象年月をファイル名から取得できません。ファイル名を「9998974_YYYYMM.xlsx」の形式にしてください。", true);
        return;
      }

      // 料率
      const ratePct = parseFloat(rateInput.value);
      if (!Number.isFinite(ratePct) || ratePct < 0 || ratePct > 100) {
        setStatus("料率（%）は 0〜100 の範囲で入力してください。", true);
        return;
      }
      const rate = ratePct / 100;

      // 集計→チェック→印刷の導線（集計したらチェックはやり直し）
      manualCheck.checked = false;
      confirmedGen = 0;

      updateFileInfo();
      setStatus("ファイルを読み込んでいます…");
      runBtn.disabled = true;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data     = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });

          const targetSheetName = workbook.SheetNames.find(n => n === "代理店報酬明細書(詳細)");
          if (!targetSheetName) {
            setStatus("ブック内に「代理店報酬明細書(詳細)」シートが見つかりません。シート名をご確認ください。", true);
            return;
          }

          const sheet = workbook.Sheets[targetSheetName];
          const json  = XLSX.utils.sheet_to_json(sheet, { defval: "" });
          if (!json.length) {
            setStatus("「代理店報酬明細書(詳細)」シート内にデータがありません。", true);
            return;
          }

          const sampleRow   = json[0];
          const contractKey = findColumnKey(sampleRow, "契約者名") || "契約者名";
          const seisekiKey  = findColumnKey(sampleRow, "成績") || "成績";
          const nyukinKey   = findColumnKey(sampleRow, "入金回数") || "入金回数";

          // 報酬列：一般的には「報酬（円）」等。念のため「企業防衛推進手当」は除外。
          const rewardKey =
            findColumnKey(sampleRow, ["報酬"], ["企業防衛"]) ||
            findColumnKey(sampleRow, "報酬") || "報酬";

          // 抽出
          const rows = [];
          for (const row of json) {
            const seiseki   = String(row[seisekiKey] || "");
            const nyukinRaw = normalizeNyukin(row[nyukinKey]);

            if (!seiseki.includes("初年度")) continue;
            if (!(nyukinRaw === "1" || nyukinRaw === "1-1")) continue;

            const firstReward    = parseAmount(row[rewardKey]);
            const bonus          = Math.floor(firstReward * 12 * rate);
            const contractorName = row[contractKey] || "";

            rows.push({ contractor: contractorName, seiseki, nyukin: nyukinRaw, firstReward, bonus });
          }

          // レポートヘッダ更新（印刷時にファイル名明示）
          updateReportHead({ year: ym.year, month: ym.month, ratePct, fileName: file.name });

          // 集計・表示
          hasAggregated = true;
          aggregateGen += 1;

          if (!rows.length) {
            tableWrapperEl.style.display = "none";
            noMatchBox.style.display = "block";
            summaryEl.innerHTML =
              `<span class="highlight">${ym.year}年${ym.month}月分企業防衛推進手当（料率 ${ratePct}%）：</span>` +
              `該当無し`;

            setStatus("集計が完了しました（該当無し）。STEP3 で「目視確認済み」にチェックを入れると、STEP4 で PDF/印刷が可能です。");
            return;
          }

          let totalBonus = 0;
          const groups = {};
          rows.forEach(r => {
            const key = r.contractor || "(契約者名なし)";
            if (!groups[key]) groups[key] = { details: [], subtotal: 0 };
            groups[key].details.push(r);
            groups[key].subtotal += r.bonus;
            totalBonus += r.bonus;
          });

          const contractorNames = Object.keys(groups).sort((a,b)=>a.localeCompare(b,"ja"));
          tbodyEl.innerHTML = "";

          contractorNames.forEach(contractorName => {
            const group = groups[contractorName];

            const headerTr = document.createElement("tr");
            headerTr.className = "group-header";
            const headerTd = document.createElement("td");
            headerTd.colSpan = 6;
            headerTd.innerHTML = `<span class="label">◆ 契約者：</span>${contractorName || "(契約者名なし)"}`;
            headerTr.appendChild(headerTd);
            tbodyEl.appendChild(headerTr);

            group.details.forEach(r => {
              const tr = document.createElement("tr");

              const tdName = document.createElement("td");
              tdName.className = "detail-row-cell";
              tdName.textContent = r.contractor;
              tr.appendChild(tdName);

              const tdTantouBlank = document.createElement("td");
              tdTantouBlank.className = "detail-row-cell";
              tr.appendChild(tdTantouBlank);

              const tdSeiseki = document.createElement("td");
              tdSeiseki.className = "detail-row-cell";
              tdSeiseki.textContent = r.seiseki;
              tr.appendChild(tdSeiseki);

              const tdNyukin = document.createElement("td");
              tdNyukin.className = "detail-row-cell";
              tdNyukin.textContent = r.nyukin;
              tr.appendChild(tdNyukin);

              const tdReward = document.createElement("td");
              tdReward.className = "num detail-row-cell";
              tdReward.textContent = r.firstReward.toLocaleString("ja-JP");
              tr.appendChild(tdReward);

              const tdBonus = document.createElement("td");
              tdBonus.className = "num detail-row-cell";
              tdBonus.textContent = r.bonus.toLocaleString("ja-JP");
              tr.appendChild(tdBonus);

              tbodyEl.appendChild(tr);
            });

            const subtotalTr = document.createElement("tr");
            subtotalTr.className = "subtotal-row";

            const tdSubtotalLabel = document.createElement("td");
            tdSubtotalLabel.textContent = "契約者小計";
            subtotalTr.appendChild(tdSubtotalLabel);

            const tdTantouInput = document.createElement("td");
            const input = document.createElement("input");
            input.type = "text";
            input.className = "subtotal-input";
            input.placeholder = "担当者名を入力";
            tdTantouInput.appendChild(input);
            subtotalTr.appendChild(tdTantouInput);

            subtotalTr.appendChild(document.createElement("td"));
            subtotalTr.appendChild(document.createElement("td"));

            const tdBlank = document.createElement("td");
            tdBlank.className = "num";
            subtotalTr.appendChild(tdBlank);

            const tdSubtotalValue = document.createElement("td");
            tdSubtotalValue.className = "num";
            tdSubtotalValue.textContent = group.subtotal.toLocaleString("ja-JP");
            subtotalTr.appendChild(tdSubtotalValue);

            tbodyEl.appendChild(subtotalTr);
          });

          tableWrapperEl.style.display = "block";
          noMatchBox.style.display = "none";

          summaryEl.innerHTML =
            `<span class="highlight">${ym.year}年${ym.month}月分企業防衛推進手当 合計（料率 ${ratePct}%）：</span>` +
            `${totalBonus.toLocaleString("ja-JP")}円`;

          setStatus("集計が完了しました。STEP3 で内容を目視確認し、「目視確認済み」にチェックを入れてから、STEP4 で PDF/印刷を行ってください。");

        } catch (err) {
          console.error(err);
          setStatus("xlsx の解析中にエラーが発生しました。ヘッダー名やシート名をご確認ください。", true);
        } finally {
          runBtn.disabled = false;
        }
      };

      reader.onerror = () => {
        setStatus("ファイル読み込みに失敗しました。", true);
        runBtn.disabled = false;
      };

      reader.readAsArrayBuffer(file);
    });

    // 初期状態
    setStatus("");
    syncActiveChip();
    updateFileInfo();
  })();
</script>
</body>
</html>
