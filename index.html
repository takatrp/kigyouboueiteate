<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>企業防衛推進手当 集計ツール（代理店報酬明細書）</title>
  <style>
    :root {
      --brand: #578899;
      --brand-dark: #456d77;
      --bg: #f4f6fa;
      --card: #ffffff;
      --ink: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 24px 16px 40px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--ink);
    }
    .shell {
      max-width: 960px;
      margin: 0 auto;
    }
    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 20px 20px 24px;
      box-shadow: 0 14px 35px rgba(15, 23, 42, 0.08);
    }
    h1 {
      font-size: 1.4rem;
      margin: 0 0 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    h1 span.badge {
      font-size: 0.72rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e0edf4;
      color: var(--brand-dark);
      font-weight: 600;
    }
    .subtitle {
      font-size: 0.88rem;
      color: var(--muted);
      margin-bottom: 16px;
    }
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px 16px;
      align-items: flex-end;
      margin-bottom: 16px;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.86rem;
    }
    label {
      color: var(--muted);
    }
    input[type="number"],
    input[type="file"] {
      font-size: 0.9rem;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #f9fafb;
    }
    input[type="number"]:focus,
    input[type="file"]:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 1px rgba(87, 136, 153, 0.25);
      background: #ffffff;
    }
    button {
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      background: var(--brand);
      color: #ffffff;
      font-size: 0.92rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(87, 136, 153, 0.35);
      transition: background 0.15s ease, transform 0.05s ease, box-shadow 0.15s ease;
    }
    button:hover {
      background: var(--brand-dark);
      box-shadow: 0 10px 24px rgba(87, 136, 153, 0.42);
    }
    button:active {
      transform: translateY(1px);
      box-shadow: 0 6px 16px rgba(87, 136, 153, 0.35);
    }
    button:disabled {
      background: #cbd5e1;
      box-shadow: none;
      cursor: default;
    }
    .status {
      font-size: 0.82rem;
      color: var(--muted);
      min-height: 1.2em;
      margin-bottom: 4px;
    }
    .summary {
      font-size: 0.92rem;
      font-weight: 600;
      margin: 6px 0 10px;
    }
    .summary span.highlight {
      color: var(--brand-dark);
    }
    .table-wrapper {
      max-height: 460px;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #f9fafb;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.84rem;
      background: #ffffff;
    }
    thead tr {
      background: #f3f4f6;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #edf0f3;
      text-align: left;
      vertical-align: middle;
    }
    th {
      font-weight: 600;
      color: #374151;
      white-space: nowrap;
    }
    td.num {
      text-align: right;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }
    tr:nth-child(even) td {
      background: #f9fafb;
    }
    .note {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 10px;
      line-height: 1.5;
    }
    @media (max-width: 640px) {
      .card {
        padding: 16px 14px 20px;
      }
      h1 {
        font-size: 1.2rem;
      }
      form {
        grid-template-columns: 1fr;
      }
      .table-wrapper {
        max-height: 360px;
      }
    }
    @media print {
      body {
        background: #ffffff;
        padding: 0;
      }
      .card {
        box-shadow: none;
        border-radius: 0;
      }
      button,
      input[type="file"] {
        display: none !important;
      }
      .table-wrapper {
        max-height: none;
        overflow: visible;
        border: none;
      }
    }
  </style>

  <!-- PDF.js（CDN） -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    if (window["pdfjsLib"]) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
    }
  </script>
</head>
<body>
<div class="shell">
  <div class="card">
    <h1>
      企業防衛推進手当 集計ツール
      <span class="badge">代理店報酬明細書 PDF 対応</span>
    </h1>
    <div class="subtitle">
      「代理店報酬明細書」の PDF から、<strong>初年度第1回報酬 × 12ヶ月 × 10％</strong> を自動集計し、企業防衛推進手当を算出します。
    </div>

    <form id="controlForm" onsubmit="return false;">
      <div class="field">
        <label for="year">対象年（西暦）</label>
        <input type="number" id="year" value="2025" min="2000" max="2100" />
      </div>
      <div class="field">
        <label for="month">対象月</label>
        <input type="number" id="month" value="7" min="1" max="12" />
      </div>
      <div class="field">
        <label for="pdfFile">代理店報酬明細書 PDF</label>
        <input type="file" id="pdfFile" accept="application/pdf" />
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <button id="runBtn" type="button">集計する</button>
      </div>
    </form>

    <div id="status" class="status"></div>
    <div id="summary" class="summary"></div>

    <div class="table-wrapper" id="tableWrapper" style="display:none;">
      <table id="resultTable">
        <thead>
          <tr>
            <th>契約者名</th>
            <th>成績</th>
            <th>入金回数</th>
            <th>初年度第1回報酬（円）</th>
            <th>企業防衛推進手当（円）</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="note">
      ・「初年度」を含み、かつ入金回数が「1」または「1-1」の行のみを対象としています。<br />
      ・企業防衛推進手当 ＝ 初年度第1回報酬 × 12ヶ月 × 10％（円未満切捨て）で計算しています。<br />
      ・PDF のレイアウト変更や別様式の場合は、抽出ロジックの微修正が必要になる場合があります。
    </div>
  </div>
</div>

<script>
  // --------------------------
  // ユーティリティ
  // --------------------------

  // PDF.js の textContent.items を行ごとにまとめる
  function groupItemsIntoLines(items) {
    const groups = [];
    const ys = [];

    const Y_THRESHOLD = 2.0; // 同じ行とみなす Y 座標差

    for (const item of items) {
      const y = item.transform[5];
      let lineIndex = -1;
      for (let i = 0; i < ys.length; i++) {
        if (Math.abs(ys[i] - y) < Y_THRESHOLD) {
          lineIndex = i;
          break;
        }
      }
      if (lineIndex === -1) {
        ys.push(y);
        groups.push([]);
        lineIndex = ys.length - 1;
      }
      groups[lineIndex].push(item);
    }

    // Y の大きい順（PDF 上では上から下へ）に並べる
    const combined = groups.map((items, idx) => ({ y: ys[idx], items }));
    combined.sort((a, b) => b.y - a.y);

    // 各行を X 順に並べてテキスト結合
    const lines = combined.map(group => {
      group.items.sort((a, b) => a.transform[4] - b.transform[4]);
      return group.items.map(it => it.str).join(" ");
    });

    // 空行は除外
    return lines.filter(line => line.trim() !== "");
  }

  // 1件分の明細（上段・下段）から情報を抽出
  function parseDetailRow(lineTop, lineBottom) {
    if (!lineBottom || lineBottom.indexOf("初年度") === -1) {
      return null;
    }

    // 「初年度」の直後にある入金回数（1 / 1-1 など）を抽出
    const nyukinMatch = lineBottom.match(/初年度\s*([0-9]+(?:\s*-\s*[0-9]+)?)/);
    if (!nyukinMatch) {
      return null;
    }
    const nyukinRaw = nyukinMatch[1].replace(/\s+/g, ""); // "1- 1" → "1-1"

    // 条件：入金回数が 1 または 1-1
    if (!(nyukinRaw === "1" || nyukinRaw === "1-1")) {
      return null;
    }

    // 成績（例：05初年度 / 01初年度）
    const idxInit = lineBottom.indexOf("初年度");
    let seiseki = "初年度";
    if (idxInit >= 0) {
      const prefix = lineBottom.slice(0, idxInit);
      const m = prefix.match(/(\d{1,2})\s*$/);
      if (m) {
        seiseki = m[1] + "初年度";
      }
    }

    // 報酬（円）＝ 行末尾の金額
    const rewardMatch = lineBottom.match(/([0-9][0-9\s,]*)\s*$/);
    if (!rewardMatch) {
      return null;
    }
    const rewardStr = rewardMatch[1].replace(/[\s,]/g, "");
    const firstReward = parseInt(rewardStr, 10);
    if (!Number.isFinite(firstReward)) {
      return null;
    }

    // 企業防衛推進手当 ＝ 初年度第1回報酬 × 12 × 10％（円未満切捨て）
    const bonus = Math.floor(firstReward * 12 * 0.1);

    // 契約者名：上段のうち「契約年月日（YY MM DD）」より前の最後の語と仮定
    let contractor = (lineTop || "").trim();
    const dateMatch = lineTop && lineTop.match(/(\d{2})\s+(\d{2})\s+(\d{2})/);
    if (dateMatch) {
      const left = lineTop.slice(0, dateMatch.index).trim();
      const parts = left.split(/\s+/);
      if (parts.length > 0) {
        contractor = parts[parts.length - 1].replace(/[（(]+$/, ""); // 末尾の（( は除去
      } else {
        contractor = left;
      }
    }

    return {
      contractor: contractor,
      seiseki: seiseki,
      nyukin: nyukinRaw,
      firstReward: firstReward,
      bonus: bonus
    };
  }

  // 指定 PDF の全ページを走査して対象行を抽出
  async function extractBonusRowsFromPdf(arrayBuffer, setStatus) {
    if (!window.pdfjsLib) {
      throw new Error("PDF.js がロードされていません。ネットワーク接続を確認してください。");
    }

    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    const results = [];

    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
      setStatus(`ページ ${pageNum}/${pdf.numPages} を解析中…`);
      const page = await pdf.getPage(pageNum);
      const textContent = await page.getTextContent();
      const lines = groupItemsIntoLines(textContent.items);

      // 「証券番号」で始まる行を「下段」とみなし、その直前を「上段」とする
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();

        // 典型的な証券番号パターン：3桁-6〜7桁-1桁
        if (!/^\d{3}-\d{6,}-\d/.test(line)) {
          continue;
        }

        const lineBottom = line;
        const lineTop = i > 0 ? lines[i - 1] : "";

        const detail = parseDetailRow(lineTop, lineBottom);
        if (detail) {
          results.push(detail);
        }
      }
    }

    return results;
  }

  // --------------------------
  // メイン処理
  // --------------------------
  (function init() {
    const statusEl = document.getElementById("status");
    const summaryEl = document.getElementById("summary");
    const tableWrapperEl = document.getElementById("tableWrapper");
    const tbodyEl = document.querySelector("#resultTable tbody");
    const runBtn = document.getElementById("runBtn");

    function setStatus(msg) {
      statusEl.textContent = msg || "";
    }

    runBtn.addEventListener("click", async () => {
      const yearInput = document.getElementById("year");
      const monthInput = document.getElementById("month");
      const fileInput = document.getElementById("pdfFile");

      const year = yearInput.value.trim();
      const month = monthInput.value.trim();
      const file = fileInput.files[0];

      summaryEl.textContent = "";
      tbodyEl.innerHTML = "";
      tableWrapperEl.style.display = "none";

      if (!file) {
        setStatus("PDFファイルを選択してください。");
        return;
      }
      if (!year || !month) {
        setStatus("対象年と対象月を入力してください。");
        return;
      }

      const monthNum = parseInt(month, 10);
      if (!Number.isFinite(monthNum) || monthNum < 1 || monthNum > 12) {
        setStatus("対象月は 1〜12 の範囲で入力してください。");
        return;
      }

      setStatus("PDF を読み込んでいます…");
      runBtn.disabled = true;

      try {
        const arrayBuffer = await file.arrayBuffer();

        const rows = await extractBonusRowsFromPdf(arrayBuffer, setStatus);

        if (!rows.length) {
          setStatus("");
          summaryEl.textContent = "該当無し";
          return;
        }

        // テーブル表示
        let totalBonus = 0;
        tbodyEl.innerHTML = "";
        rows.forEach(r => {
          totalBonus += r.bonus;
          const tr = document.createElement("tr");

          const tdName = document.createElement("td");
          tdName.textContent = r.contractor || "";
          tr.appendChild(tdName);

          const tdSeiseki = document.createElement("td");
          tdSeiseki.textContent = r.seiseki;
          tr.appendChild(tdSeiseki);

          const tdNyukin = document.createElement("td");
          tdNyukin.textContent = r.nyukin;
          tr.appendChild(tdNyukin);

          const tdReward = document.createElement("td");
          tdReward.className = "num";
          tdReward.textContent = r.firstReward.toLocaleString("ja-JP");
          tr.appendChild(tdReward);

          const tdBonus = document.createElement("td");
          tdBonus.className = "num";
          tdBonus.textContent = r.bonus.toLocaleString("ja-JP");
          tr.appendChild(tdBonus);

          tbodyEl.appendChild(tr);
        });

        tableWrapperEl.style.display = "";
        setStatus("");

        summaryEl.innerHTML =
          `<span class="highlight">${year}年${monthNum}月分企業防衛推進手当 合計：</span>` +
          `${totalBonus.toLocaleString("ja-JP")}円`;

      } catch (err) {
        console.error(err);
        setStatus("PDF の解析中にエラーが発生しました。レイアウトが想定と異なる可能性があります。");
      } finally {
        runBtn.disabled = false;
      }
    });
  })();
</script>
</body>
</html>
