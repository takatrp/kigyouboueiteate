<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>企業防衛推進手当 集計ツール（代理店報酬明細書(詳細)）</title>
  <style>
    :root{
      --brand:#578899;
      --brand-dark:#456d77;
      --bg:#f4f6fa;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent-soft:#e5f0f6;
      --subtotal-bg:#fef9c3;
      --chip-bg:#eef2f7;
      --chip-bg-active:#e0edf4;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      padding:24px 16px 40px;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--ink);
    }
    .shell{max-width:1040px;margin:0 auto;}
    .card{
      background:var(--card);
      border-radius:16px;
      padding:20px 20px 24px;
      box-shadow:0 14px 35px rgba(15,23,42,0.08);
    }
    h1{
      font-size:1.4rem;
      margin:0 0 6px;
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    h1 .badge{
      font-size:0.72rem;
      padding:2px 8px;
      border-radius:999px;
      background:#e0edf4;
      color:var(--brand-dark);
      font-weight:600;
    }
    .subtitle{
      font-size:0.88rem;
      color:var(--muted);
      margin-bottom:10px;
    }

    .flow{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:14px;
      font-size:0.8rem;
    }
    .flow-step{
      display:flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      background:var(--accent-soft);
      color:#1f2933;
      white-space:nowrap;
    }
    .flow-step .step-no{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:20px;height:20px;
      border-radius:999px;
      background:var(--brand);
      color:#fff;
      font-size:0.72rem;
      font-weight:700;
    }
    .flow-step .step-text{font-weight:500;}

    form{margin:0;}
    .workflow-grid{
      display:grid;
      grid-template-columns: 1.6fr 0.9fr;
      gap:14px;
      align-items:start;
      margin-bottom:8px;
    }
    .step-card{
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      padding:12px;
      box-shadow:0 6px 14px rgba(15,23,42,0.05);
    }
    .step-card-head{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
      padding-bottom:8px;
      border-bottom:1px dashed #e5e7eb;
    }
    .step-pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      padding:3px 10px;
      background:var(--brand);
      color:#fff;
      font-size:0.75rem;
      font-weight:800;
      letter-spacing:0.02em;
    }
    .step-title{
      font-weight:800;
      color:#111827;
      font-size:0.92rem;
    }
    .step-desc{
      margin-left:auto;
      color:var(--muted);
      font-size:0.78rem;
      font-weight:500;
      white-space:nowrap;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:0.86rem;
    }
    label{color:var(--muted);}
    input[type="number"],
    input[type="file"],
    input[type="text"]{
      font-size:0.9rem;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid var(--border);
      background:#f9fafb;
    }
    input[type="number"]:focus,
    input[type="file"]:focus,
    input[type="text"]:focus{
      outline:none;
      border-color:var(--brand);
      box-shadow:0 0 0 1px rgba(87,136,153,0.25);
      background:#fff;
    }

    .step1-body{display:grid;gap:12px;}
    .two-col{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }

    .rate-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px;}
    .chip{
      border:1px solid var(--border);
      background:var(--chip-bg);
      color:#111827;
      border-radius:999px;
      padding:6px 10px;
      font-size:0.82rem;
      cursor:pointer;
      user-select:none;
      box-shadow:0 2px 6px rgba(148,163,184,0.25);
    }
    .chip:hover{background:#e5e7eb;}
    .chip.active{
      border-color:rgba(87,136,153,0.7);
      background:var(--chip-bg-active);
      box-shadow:0 6px 14px rgba(87,136,153,0.20);
      font-weight:700;
      color:var(--brand-dark);
    }

    .button-row{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:stretch;
    }
    button{
      padding:10px 16px;
      border-radius:999px;
      border:none;
      font-size:0.92rem;
      font-weight:700;
      cursor:pointer;
      transition:background 0.15s ease, transform 0.05s ease, box-shadow 0.15s ease;
      width:100%;
      text-align:center;
    }
    button.primary{
      background:var(--brand);
      color:#fff;
      box-shadow:0 8px 20px rgba(87,136,153,0.35);
    }
    button.primary:hover{background:var(--brand-dark);box-shadow:0 10px 24px rgba(87,136,153,0.42);}
    button.primary:active{transform:translateY(1px);box-shadow:0 6px 16px rgba(87,136,153,0.35);}
    button.secondary{
      background:#e5e7eb;
      color:#111827;
      box-shadow:0 3px 8px rgba(148,163,184,0.35);
    }
    button.secondary:hover{background:#d1d5db;}
    button.secondary:active{transform:translateY(1px);box-shadow:0 2px 6px rgba(148,163,184,0.30);}
    button:disabled{background:#cbd5e1;box-shadow:none;cursor:default;}

    .check-label{
      display:flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      font-size:0.9rem;
      color:#111827;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#f9fafb;
    }
    .check-label small{
      display:block;
      color:var(--muted);
      font-size:0.78rem;
      font-weight:500;
      margin-top:2px;
    }
    .check-label input[type="checkbox"]{
      width:18px;height:18px;cursor:pointer;
      accent-color: var(--brand);
    }

    .file-info{
      font-size:0.8rem;
      color:var(--muted);
      margin:6px 0 8px;
    }
    .status{
      font-size:0.82rem;
      color:var(--muted);
      min-height:1.2em;
      margin-bottom:6px;
    }
    .summary{
      font-size:0.92rem;
      font-weight:700;
      margin:6px 0 10px;
    }
    .summary .highlight{color:var(--brand-dark);}

    /* ★修正：display:none をCSSから外す（表示制御はJSでblock/none） */
    .table-wrapper{
      max-height:520px;
      overflow:auto;
      border-radius:10px;
      border:1px solid var(--border);
      background:#f9fafb;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:0.84rem;
      background:#fff;
    }
    thead tr{
      background:#f3f4f6;
      position:sticky;
      top:0;
      z-index:1;
    }
    th, td{
      padding:6px 8px;
      border-bottom:1px solid #edf0f3;
      text-align:left;
      vertical-align:middle;
    }
    th{
      font-weight:700;
      color:#374151;
      white-space:nowrap;
    }
    td.num{
      text-align:right;
      font-variant-numeric:tabular-nums;
      white-space:nowrap;
    }
    tr:nth-child(even) td.detail-row-cell{background:#f9fafb;}
    .group-header td{
      background:var(--accent-soft);
      font-weight:700;
      color:#1f2937;
      border-bottom:1px solid #d1d5db;
    }
    .group-header .label{opacity:0.9;}
    .subtotal-row td{
      background:var(--subtotal-bg);
      font-weight:800;
      border-top:1px solid #eab308;
      border-bottom:1px solid #eab308;
    }
    .subtotal-input{max-width:160px;font-size:0.8rem;}
    .note{
      font-size:0.8rem;
      color:var(--muted);
      margin-top:10px;
      line-height:1.5;
    }

    @media (max-width: 860px){
      .workflow-grid{grid-template-columns: 1fr;}
      .two-col{grid-template-columns:1fr;}
      .step-desc{display:none;}
    }

    @media print{
      body{background:#fff;padding:0;}
      .card{box-shadow:none;border-radius:0;}
      .flow{display:none !important;}
      input[type="file"]{display:none !important;}
      .button-row button, .check-label{display:none !important;}
      .table-wrapper{max-height:none;overflow:visible;border:none;display:block !important;}
      thead tr{position:static !important;}
      thead{display:table-header-group;}
      tfoot{display:table-footer-group;}
      tr, td, th{page-break-inside:avoid;}
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="shell">
  <div class="card">
    <h1>
      企業防衛推進手当 集計ツール
      <span class="badge">代理店報酬明細書(詳細) シート対応</span>
    </h1>
    <div class="subtitle">
      「代理店報酬明細書(詳細)」シートから、<strong>初年度第1回報酬 × 12ヶ月 × 料率</strong> を契約者ごとに集計し、担当者入力と目視確認付きのレポートを作成します。
    </div>

    <div class="flow">
      <div class="flow-step"><span class="step-no">1</span><span class="step-text">対象年月とファイルを指定</span></div>
      <div class="flow-step"><span class="step-no">2</span><span class="step-text">「集計する」を押す</span></div>
      <div class="flow-step"><span class="step-no">3</span><span class="step-text">内容を確認し「目視確認済み」にチェック</span></div>
      <div class="flow-step"><span class="step-no">4</span><span class="step-text">「PDF/印刷」でレポート出力</span></div>
    </div>

    <form id="controlForm" onsubmit="return false;">
      <div class="workflow-grid">
        <section class="step-card">
          <div class="step-card-head">
            <span class="step-pill">STEP1</span>
            <div class="step-title">入力（Excel・対象年月・料率）</div>
            <div class="step-desc">左→右で作業</div>
          </div>

          <div class="step1-body">
            <div class="field">
              <label for="xlsxFile">代理店報酬明細書（.xlsx）</label>
              <input type="file" id="xlsxFile" accept=".xlsx,.xls" />
            </div>

            <div class="two-col">
              <div class="field">
                <label for="year">対象年（西暦）</label>
                <input type="number" id="year" value="2025" min="2000" max="2100" />
              </div>
              <div class="field">
                <label for="month">対象月</label>
                <input type="number" id="month" value="3" min="1" max="12" />
              </div>
            </div>

            <div class="field">
              <label for="ratePct">料率（%）</label>
              <div class="rate-row">
                <input type="number" id="ratePct" value="10" min="0" max="100" step="0.1" />
              </div>
              <div class="chips" id="rateChips">
                <button type="button" class="chip active" data-rate="10">10%</button>
                <button type="button" class="chip" data-rate="15">15%</button>
                <button type="button" class="chip" data-rate="20">20%</button>
                <button type="button" class="chip" data-rate="25">25%</button>
                <button type="button" class="chip" data-rate="30">30%</button>
              </div>
            </div>
          </div>
        </section>

        <section class="step-card">
          <div class="step-card-head">
            <span class="step-pill">STEP2-4</span>
            <div class="step-title">集計・確認・印刷</div>
            <div class="step-desc">上→下で実行</div>
          </div>

          <div class="button-row">
            <button id="runBtn" type="button" class="primary">STEP2 集計する</button>

            <label class="check-label">
              <input type="checkbox" id="manualCheck" />
              <div>
                <div><strong>STEP3 目視確認済み</strong></div>
                <small>チェックが無い場合、PDF/印刷はできません</small>
              </div>
            </label>

            <button id="printBtn" type="button" class="secondary">STEP4 PDF/印刷</button>
          </div>
        </section>
      </div>
    </form>

    <div id="fileInfo" class="file-info"></div>
    <div id="status" class="status"></div>
    <div id="summary" class="summary"></div>

    <!-- ★修正：初期状態はHTML側で非表示（JSでblockにする） -->
    <div class="table-wrapper" id="tableWrapper" style="display:none;">
      <table id="resultTable">
        <thead>
          <tr>
            <th>契約者名</th>
            <th>担当者</th>
            <th>成績</th>
            <th>入金回数</th>
            <th>初年度第1回報酬（円）</th>
            <th>企業防衛推進手当（円）</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="note">
      ・成績列に「初年度」を含み、かつ入金回数が「1」または「1-1」の行のみを対象としています。<br />
      ・企業防衛推進手当 ＝ 初年度第1回報酬 × 12ヶ月 × 料率（%/100）（円未満切捨て）で計算しています。<br />
      ・契約者ごとに小計行を表示し、小計行に担当者名を入力できます（印刷・PDF にも反映されます）。<br />
      ・該当無しの場合でも、「目視確認済み」にチェックした上で PDF/印刷が可能です。
    </div>
  </div>
</div>

<script>
  function parseAmount(val) {
    if (val == null) return 0;
    if (typeof val === "number") return Math.floor(val);
    const digits = String(val).replace(/[^\d]/g, "");
    return digits ? parseInt(digits, 10) : 0;
  }

  function findColumnKey(sampleRow, includeKeywords, excludeKeywords) {
    const keys = Object.keys(sampleRow || {});
    const includes = Array.isArray(includeKeywords) ? includeKeywords : [includeKeywords];
    const excludes = Array.isArray(excludeKeywords) ? excludeKeywords : (excludeKeywords ? [excludeKeywords] : []);
    for (const key of keys) {
      if (includes.every(k => key.includes(k)) && excludes.every(k => !key.includes(k))) return key;
    }
    return null;
  }

  function normalizeNyukin(val) {
    if (val == null) return "";
    let s = String(val);
    s = s.replace("－", "-");
    s = s.replace(/\s+/g, "");
    return s;
  }

  (function init() {
    const statusEl       = document.getElementById("status");
    const summaryEl      = document.getElementById("summary");
    const tableWrapperEl = document.getElementById("tableWrapper");
    const tbodyEl        = document.querySelector("#resultTable tbody");
    const runBtn         = document.getElementById("runBtn");
    const printBtn       = document.getElementById("printBtn");
    const manualCheck    = document.getElementById("manualCheck");
    const fileInput      = document.getElementById("xlsxFile");
    const fileInfoEl     = document.getElementById("fileInfo");
    const yearInput      = document.getElementById("year");
    const monthInput     = document.getElementById("month");
    const rateInput      = document.getElementById("ratePct");
    const chipsWrap      = document.getElementById("rateChips");

    let hasAggregated = false;
    let aggregateGen  = 0;
    let confirmedGen  = 0;

    function setStatus(msg) { statusEl.textContent = msg || ""; }

    function autoFillYearMonthFromFilename(fileName) {
      if (!fileName) return;
      let match = fileName.match(/_(\d{6})(?=\.(xlsx|xls)$)/i);
      if (!match) match = fileName.match(/(\d{6})(?=\.(xlsx|xls)$)/i);
      if (!match) return;

      const yyyymm = match[1];
      const yearNum  = parseInt(yyyymm.slice(0, 4), 10);
      const monthNum = parseInt(yyyymm.slice(4, 6), 10);

      if (Number.isFinite(yearNum) && yearNum >= 2000 && yearNum <= 2100) yearInput.value = yearNum;
      if (Number.isFinite(monthNum) && monthNum >= 1 && monthNum <= 12) monthInput.value = monthNum;
    }

    function updateFileInfo() {
      const file = fileInput.files[0];
      if (file) {
        fileInfoEl.textContent = "読込ファイル：" + file.name;
        autoFillYearMonthFromFilename(file.name);
      } else {
        fileInfoEl.textContent = "";
      }
    }
    fileInput.addEventListener("change", updateFileInfo);

    function syncActiveChip() {
      const current = parseFloat(rateInput.value);
      const chips = chipsWrap.querySelectorAll(".chip");
      chips.forEach(btn => {
        const r = parseFloat(btn.dataset.rate);
        btn.classList.toggle("active", Number.isFinite(current) && Number.isFinite(r) && current === r);
      });
    }
    chipsWrap.addEventListener("click", (ev) => {
      const btn = ev.target.closest(".chip");
      if (!btn) return;
      rateInput.value = btn.dataset.rate;
      syncActiveChip();
    });
    rateInput.addEventListener("input", syncActiveChip);

    manualCheck.addEventListener("change", () => {
      if (manualCheck.checked && hasAggregated) confirmedGen = aggregateGen;
      else confirmedGen = 0;
    });

    printBtn.addEventListener("click", () => {
      if (!hasAggregated) { setStatus("先に STEP2「集計する」を実行してください。"); return; }
      if (!manualCheck.checked) { setStatus("STEP3「目視確認済み」にチェックを入れてから、STEP4「PDF/印刷」を行ってください。"); return; }
      if (confirmedGen !== aggregateGen) { setStatus("最新の集計結果について、改めて「目視確認済み」にチェックを入れてください。"); return; }

      setStatus("");

      const originalTitle = document.title;
      const yearVal  = yearInput.value.trim();
      const monthNum = parseInt(monthInput.value.trim(), 10);

      let newTitle = originalTitle;
      if (yearVal && Number.isFinite(monthNum) && monthNum >= 1 && monthNum <= 12) {
        newTitle = `${yearVal}年${monthNum}月企業防衛手当明細`;
      }
      document.title = newTitle;

      window.print();

      setTimeout(() => { document.title = originalTitle; }, 1000);
    });

    runBtn.addEventListener("click", () => {
      const year  = yearInput.value.trim();
      const month = monthInput.value.trim();
      const file  = fileInput.files[0];

      const ratePct = parseFloat(rateInput.value);
      if (!Number.isFinite(ratePct) || ratePct < 0 || ratePct > 100) {
        setStatus("料率（%）は 0〜100 の範囲で入力してください。");
        return;
      }
      const rate = ratePct / 100;

      summaryEl.textContent = "";
      tbodyEl.innerHTML = "";
      tableWrapperEl.style.display = "none"; // ★ここは明示

      if (!file) { setStatus("xlsx ファイルを選択してください。"); return; }
      if (!year || !month) { setStatus("対象年と対象月を入力（または自動設定）してください。"); return; }

      const monthNum = parseInt(month, 10);
      if (!Number.isFinite(monthNum) || monthNum < 1 || monthNum > 12) {
        setStatus("対象月は 1〜12 の範囲で入力してください。");
        return;
      }

      updateFileInfo();
      setStatus("ファイルを読み込んでいます…");
      runBtn.disabled = true;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data     = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });

          const targetSheetName = workbook.SheetNames.find(name => name === "代理店報酬明細書(詳細)");
          if (!targetSheetName) {
            setStatus("ブック内に「代理店報酬明細書(詳細)」シートが見つかりません。シート名をご確認ください。");
            runBtn.disabled = false;
            return;
          }

          const sheet = workbook.Sheets[targetSheetName];
          const json  = XLSX.utils.sheet_to_json(sheet, { defval: "" });
          if (!json.length) {
            setStatus("「代理店報酬明細書(詳細)」シート内にデータがありません。");
            runBtn.disabled = false;
            return;
          }

          const sampleRow   = json[0];
          const contractKey = findColumnKey(sampleRow, "契約者名") || "契約者名";
          const seisekiKey  = findColumnKey(sampleRow, "成績")    || "成績";
          const nyukinKey   = findColumnKey(sampleRow, "入金回数") || "入金回数";
          const rewardKey   =
            findColumnKey(sampleRow, ["報酬"], ["計算用"]) ||
            findColumnKey(sampleRow, "報酬") || "報酬";

          const rows = [];
          for (const row of json) {
            const seiseki   = String(row[seisekiKey] || "");
            const nyukinRaw = normalizeNyukin(row[nyukinKey]);

            if (!seiseki.includes("初年度")) continue;
            if (!(nyukinRaw === "1" || nyukinRaw === "1-1")) continue;

            const firstReward    = parseAmount(row[rewardKey]);
            const bonus          = Math.floor(firstReward * 12 * rate);
            const contractorName = row[contractKey] || "";

            rows.push({ contractor: contractorName, seiseki, nyukin: nyukinRaw, firstReward, bonus });
          }

          let totalBonus = 0;
          const groups = {};
          rows.forEach(r => {
            const key = r.contractor || "(契約者名なし)";
            if (!groups[key]) groups[key] = { details: [], subtotal: 0 };
            groups[key].details.push(r);
            groups[key].subtotal += r.bonus;
            totalBonus += r.bonus;
          });

          tbodyEl.innerHTML = "";

          if (!rows.length) {
            tableWrapperEl.style.display = "none";
            hasAggregated = true;
            aggregateGen += 1;
            confirmedGen = 0;
            setStatus("集計が完了しました（該当する初年度第1回報酬はありません）。STEP3 で「目視確認済み」にチェックを入れると、STEP4 で PDF/印刷が可能です。");
            summaryEl.textContent = "該当無し";
            runBtn.disabled = false;
            return;
          }

          const contractorNames = Object.keys(groups).sort((a, b) => a.localeCompare(b, "ja"));

          contractorNames.forEach(contractorName => {
            const group = groups[contractorName];

            const headerTr = document.createElement("tr");
            headerTr.className = "group-header";
            const headerTd = document.createElement("td");
            headerTd.colSpan = 6;
            headerTd.innerHTML = `<span class="label">◆ 契約者：</span>${contractorName || "(契約者名なし)"}`;
            headerTr.appendChild(headerTd);
            tbodyEl.appendChild(headerTr);

            group.details.forEach(r => {
              const tr = document.createElement("tr");

              const tdName = document.createElement("td");
              tdName.className = "detail-row-cell";
              tdName.textContent = r.contractor;
              tr.appendChild(tdName);

              const tdTantou = document.createElement("td");
              tdTantou.className = "detail-row-cell";
              tr.appendChild(tdTantou);

              const tdSeiseki = document.createElement("td");
              tdSeiseki.className = "detail-row-cell";
              tdSeiseki.textContent = r.seiseki;
              tr.appendChild(tdSeiseki);

              const tdNyukin = document.createElement("td");
              tdNyukin.className = "detail-row-cell";
              tdNyukin.textContent = r.nyukin;
              tr.appendChild(tdNyukin);

              const tdReward = document.createElement("td");
              tdReward.className = "num detail-row-cell";
              tdReward.textContent = r.firstReward.toLocaleString("ja-JP");
              tr.appendChild(tdReward);

              const tdBonus = document.createElement("td");
              tdBonus.className = "num detail-row-cell";
              tdBonus.textContent = r.bonus.toLocaleString("ja-JP");
              tr.appendChild(tdBonus);

              tbodyEl.appendChild(tr);
            });

            const subtotalTr = document.createElement("tr");
            subtotalTr.className = "subtotal-row";

            const tdSubtotalLabel = document.createElement("td");
            tdSubtotalLabel.textContent = "契約者小計";
            subtotalTr.appendChild(tdSubtotalLabel);

            const tdTantouInput = document.createElement("td");
            const input = document.createElement("input");
            input.type = "text";
            input.className = "subtotal-input";
            input.placeholder = "担当者名を入力";
            tdTantouInput.appendChild(input);
            subtotalTr.appendChild(tdTantouInput);

            subtotalTr.appendChild(document.createElement("td"));
            subtotalTr.appendChild(document.createElement("td"));

            const tdBlank3 = document.createElement("td");
            tdBlank3.className = "num";
            subtotalTr.appendChild(tdBlank3);

            const tdSubtotalValue = document.createElement("td");
            tdSubtotalValue.className = "num";
            tdSubtotalValue.textContent = group.subtotal.toLocaleString("ja-JP");
            subtotalTr.appendChild(tdSubtotalValue);

            tbodyEl.appendChild(subtotalTr);
          });

          tableWrapperEl.style.display = "block"; // ★ここが重要：必ずblockで表示
          hasAggregated = true;
          aggregateGen += 1;
          confirmedGen = 0;

          setStatus("集計が完了しました。STEP3 で内容を目視確認し、「目視確認済み」にチェックを入れてから、STEP4 で PDF/印刷を行ってください。");

          summaryEl.innerHTML =
            `<span class="highlight">${year}年${monthNum}月分企業防衛推進手当 合計（料率 ${ratePct}%）：</span>` +
            `${totalBonus.toLocaleString("ja-JP")}円`;

        } catch (err) {
          console.error(err);
          setStatus("xlsx の解析中にエラーが発生しました。ヘッダー名やシート名をご確認ください。");
        } finally {
          runBtn.disabled = false;
        }
      };

      reader.onerror = () => {
        setStatus("ファイル読み込みに失敗しました。");
        runBtn.disabled = false;
      };

      reader.readAsArrayBuffer(file);
    });

    syncActiveChip();
  })();
</script>
</body>
</html>
